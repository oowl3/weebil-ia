generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // ← ESTA LÍNEA ES NECESARIA EN PRISMA 6.x
}

// --- AUTH: Modelos Estándar de NextAuth ---
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  analisis             Analisis[]
  animalesDesbloqueados AnimalDesbloqueado[]
  conversacionesIA     ConversacionIA[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// --- CONVERSACIONES CON IA ---
model ConversacionIA {
  id                String   @id @default(cuid())
  creadoEn          DateTime @default(now())
  usuarioId         String?
  usuario           User?    @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  guestId           String?
  mensajeUsuario    String   @db.Text
  respuestaIA       String   @db.Text
  modeloIA          String?
  tokensUtilizados  Int?
  tipoConsulta      String?
  animalReferenciadoId Int?
  animalReferenciado Animal? @relation(fields: [animalReferenciadoId], references: [id])
  
  // RELACIÓN INVERSA CON ANALISIS (uno-a-muchos)
  analisisRelacionados Analisis[]

  @@index([usuarioId])
  @@index([guestId])
  @@index([creadoEn])
  @@map("conversaciones_ia")
}

// --- DOMINIO: Lógica de Negocio ---
model Animal {
  id                Int      @id @default(autoincrement()) 
  nombreComun       String
  nombreCientifico  String?
  esVenenoso        Boolean?
  descripcion       String?
  habitat           String?
  primerosAuxilios  String?
  rutaImagenCard    String?
  creadoEn          DateTime @default(now())
  animalAntidoto    AnimalAntidoto[]
  analisis          Analisis[]
  desbloqueadoPor   AnimalDesbloqueado[]
  conversacionesReferenciadas ConversacionIA[]

  @@map("animales")
}

model AnimalDesbloqueado {
  usuarioId String
  animalId  Int 
  desbloqueadoEn DateTime @default(now())
  usuario   User    @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  animal    Animal  @relation(fields: [animalId], references: [id], onDelete: Cascade)

  @@id([usuarioId, animalId])
  @@map("animales_desbloqueados")
}

model Antidoto {
  id                Int      @id @default(autoincrement()) 
  nombre            String   @unique
  descripcion       String?
  creadoEn          DateTime @default(now())
  animalAntidoto    AnimalAntidoto[]
  hospitalAntidoto  HospitalAntidoto[]
  analisisSugeridos Analisis[]

  @@map("antidotos")
}

model AnimalAntidoto {
  animalId    Int 
  antidotoId  Int 
  animal      Animal   @relation(fields: [animalId], references: [id], onDelete: Cascade)
  antidoto    Antidoto @relation(fields: [antidotoId], references: [id], onDelete: Cascade)

  @@id([animalId, antidotoId])
  @@map("animales_antidotos")
}

model Hospital {
  id                 Int      @id @default(autoincrement()) 
  nombre             String
  direccion          String
  telefono           String?
  latitud            Float
  longitud           Float
  ultimaVerificacion DateTime?
  creadoEn           DateTime @default(now())
  hospitalAntidoto     HospitalAntidoto[]
  analisisRecomendados Analisis[]

  @@map("hospitales")
}

model HospitalAntidoto {
  hospitalId Int 
  antidotoId Int 
  stock      Int?     @default(0)
  hospital   Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  antidoto   Antidoto @relation(fields: [antidotoId], references: [id], onDelete: Cascade)

  @@id([hospitalId, antidotoId])
  @@map("hospitales_antidotos")
}

model Analisis {
  id                Int      @id @default(autoincrement()) 
  creadoEn          DateTime @default(now())
  rutaImagen        String
  latitudUsuario    Float?
  longitudUsuario   Float?
  usuarioId         String?  
  usuario           User?    @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  guestId           String?
  animalDetectadoId     Int? 
  animalDetectado       Animal?   @relation(fields: [animalDetectadoId], references: [id], onDelete: SetNull)
  esVenenosoDetectado   Boolean?
  descripcionIA         String?
  primerosAuxiliosIA    String?
  confianzaIA           Float?
  antidotoSugeridoId    Int? 
  antidotoSugerido      Antidoto? @relation(fields: [antidotoSugeridoId], references: [id], onDelete: SetNull)
  hospitalRecomendadoId Int? 
  hospitalRecomendado   Hospital? @relation(fields: [hospitalRecomendadoId], references: [id], onDelete: SetNull)
  
  // Relación con conversación IA (uno-a-muchos)
  conversacionIAId String?
  conversacionIA   ConversacionIA? @relation(fields: [conversacionIAId], references: [id])

  @@index([guestId])
  @@map("analisis")
}